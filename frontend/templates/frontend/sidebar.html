{% load static %}
<header id="header" class="header fixed-top d-flex align-items-center">

  <div class="d-flex align-items-center justify-content-between">
    <a href="" class="logo d-flex align-items-center">
      <img src="{% static 'frontend/img/iBuy.png' %}" alt="logo" style="scale: 1.5;">
    </a>
    <i class="bi bi-list toggle-sidebar-btn"></i>
  </div><!-- End Logo -->

  <nav class="header-nav ms-auto">
    <ul class="d-flex align-items-center">

      <li class="nav-item dropdown">

        <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
          <i class="bi bi-bell"></i>
          <span class="badge bg-danger badge-number d-none" id="notificationCount">4</span>
        </a><!-- End Notification Icon -->

        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications" ">
          <li class="dropdown-header">
            <a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Mark All as Read</span></a>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>

          <div id="notificationContainer">

          </div>


          <li class="dropdown-footer">
            <a href="#">Show all notifications</a>
          </li>

        </ul><!-- End Notification Dropdown Items -->

      </li><!-- End Notification Nav -->

      <li class="nav-item dropdown pe-3">

        <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
          <img src="{% if user.photo %}{{user.photo.url}}{% endif %}" alt="Profile"
            onerror="this.src='{{user.default_photo_url}}';">
          <span class="d-none d-md-block dropdown-toggle ps-2">{{user.get_short_name}}</span>
        </a><!-- End Profile Iamge Icon -->

        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
          <li class="dropdown-header">
            <h6>{{user.get_full_name}}</h6>
            <span>{{user.role}}</span>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>

          <li>
            <a class="dropdown-item d-flex align-items-center" href="/profile">
              <i class="bi bi-person"></i>
              <span>My Profile</span>
            </a>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>

          
          <li>
            <hr class="dropdown-divider">
          </li>

          <li>
            <a class="dropdown-item d-flex align-items-center" href="/faq">
              <i class="bi bi-question-circle"></i>
              <span>FAQs</span>
            </a>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>

          <li>
            <a class="dropdown-item d-flex align-items-center" id="logoutButton" href="#">
              <i class="bi bi-box-arrow-right"></i>
              <span>Log Out</span>
            </a>
          </li>

        </ul><!-- End Profile Dropdown Items -->
      </li><!-- End Profile Nav -->

    </ul>
  </nav><!-- End Icons Navigation -->

</header><!-- End Header -->

<!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">

  <ul class="sidebar-nav" id="sidebar-nav">

    {% if user.is_superuser %}

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'admin-dashboard'%}collapsed{% endif %}" href="/admin/dashboard">
        <i class="bi bi-grid"></i>
        <span>Dashboard</span>
      </a>
    </li><!-- End Dashboard Nav -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-uniforms'%}collapsed{% endif %}"
        href="/admin/manage-uniforms">
        <i class="bi bi-universal-access"></i>
        <span>Manage Uniforms</span>
      </a>
    </li><!-- End Uniforms Page Nav -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-orders'%}collapsed{% endif %}" href="/admin/manage-orders">
        <i class="bi bi-cart-check-fill"></i>
        <span>Manage Orders</span>
      </a>
    </li><!-- End Uniforms Page Nav -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-expenses'%}collapsed{% endif %}" href="/admin/manage-expenses">
        <i class="bi bi-currency-dollar"></i>
        <span>Manage Expenses</span>
      </a>
    </li><!-- End Uniforms Page Nav -->


    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-user'%}collapsed{% endif %}" href="/admin/manage-users">
        <i class="bi bi-people"></i>
        <span>Manage User</span>
      </a>
    </li><!-- End Users Page Nav -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-faqs'%}collapsed{% endif %}" href="/admin/manage-faqs">
        <i class="bi bi-question-circle"></i>
        <span>Manage FAQ's</span>
      </a>
    </li><!-- End FAQs Page Nav -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'manage-system-informations'%}collapsed{% endif %}"
        href="/admin/manage-system-informations">
        <i class="bi bi-building-exclamation"></i>
        <span style="font-size: 14px;">Manage System Information</span>
      </a>
    </li><!-- End System Information Page Nav -->


    <!-- <li class="nav-item">
      <a class="nav-link collapsed" href="users-profile.html">
        <i class="bi bi-bank"></i>
        <span>Inventory and Treasury</span>
      </a>
    </li> 

    <li class="nav-item">
      <a class="nav-link collapsed" href="users-profile.html">
        <i class="bi bi-activity"></i>
        <span>Reports</span>
      </a>
    </li> -->

    {% endif %}

    {% if not user.is_superuser %}
    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'uniforms'%}collapsed{% endif %}" href="/uniforms">
        <i class="bi bi-globe"></i>
        <span>Browse Uniforms</span>
      </a>
    </li><!-- Browse Uniforms -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'my-cart'%}collapsed{% endif %}" href="/my-cart">
        <i class="bi bi-cart"></i>
        <span>My Cart</span>
      </a>
    </li><!-- My Cart -->

    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'my-orders'%}collapsed{% endif %}" href="/my-orders">
        <i class="bi bi-cart4"></i>
        <span>My Orders</span>
      </a>
    </li><!-- My Orders -->
    {% endif %}


    <li class="nav-item">
      <a class="nav-link {% if not current_page == 'about'%}collapsed{% endif %}" href="/about">
        <i class="bi bi-exclamation-circle"></i>
        <span>About</span>
      </a>
    </li><!-- End About Page Nav -->

  </ul>

</aside><!-- End Sidebar-->

<script>
  const logoutButton = document.getElementById('logoutButton')
  const notificationCount = document.getElementById('notificationCount')
  const notificationContainer = document.getElementById('notificationContainer')

  logoutButton.addEventListener('click', function () {
    const url = '/api/v1/logout';
    const payload = {
      method: 'POST',
      headers: {
        "X-CSRFToken": "{{csrf_token}}",
        "Content-Type": 'application/json'
      }
    }

    fetch(url, payload)
      .then(response => response.json())
      .then(response => {
        console.log(response)
        // process success here
        if (response.status === 'success') {
          window.location.href = '/login';
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Something went wrong!',
          confirmButtonColor: '#4154f1',
        })
      });
  });

  const formatDate = (dateString) => {
        // Parse the date string
        let date = new Date(dateString);
        // Define options for formatting
        let options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour12: true,
        };
        // Format the date
        let formattedDate = date.toLocaleDateString('en-US', options);
        return formattedDate
  }

  const renderNotification = (notification) => {
        // Create a new HTML structure using JavaScript
        var newItem = document.createElement('li');
        newItem.className = 'notification-item';
        newItem.style.cursor = 'pointer'
        newItem.setAttribute('link', notification.link)

        // Create the first div with nested div and icon
        newItem.innerHTML = `
          <i class="bi bi-bell-fill text-${notification.level}"></i>
          <div ${notification.status == 'unseen' ? 'style="font-weight: bold;"':''}>
            <p>${notification.content}</p>
            <p class="text-muted"> ${formatDate(notification.modified_at)}</p>
          </div>
        `;
      
        var newItemDivider = document.createElement('li');
        newItemDivider.innerHTML = `<hr class="dropdown-divider"> `;
        
        // add event to redirect to notif link
        newItem.addEventListener('click', function() {
            window.location.href = this.getAttribute('link')
        });

        notificationContainer.appendChild(newItem);
        notificationContainer.appendChild(newItemDivider);
    }

    const getNotifications = async () => {
        const url = '/api/v1/notifications';
        const payload = {
            method: 'GET',
            headers: {
                "X-CSRFToken": "{{csrf_token}}",
                "Content-Type": 'application/json'
            }
        }

        fetch(url, payload)
            .then(response => response.json())
            .then(response => {
                data = response.data
                notifications = data.rows
                count = data.count

                if (count){
                    notificationCount.classList.remove('d-none')
                    notificationCount.innerText = count
                }

                notifications.forEach((obj) => {
                    renderNotification(obj)
                })
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: error,
                    confirmButtonColor: '#4154f1',
                })
            });
    }
    getNotifications()

</script>